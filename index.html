<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SwipeTree — Family Navigator</title>
  <style>
*{box-sizing:border-box;-webkit-tap-highlight-color: transparent;}
html,body{margin:0;padding:0;background:#000;color:#fff;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  -webkit-touch-callout:none; user-select:none; -webkit-user-select:none;}
img{-webkit-touch-callout:none}
#app{display:flex;flex-direction:column;height:100%;}
.topbar{display:flex;align-items:center;gap:.75rem;padding:.5rem .75rem;background:#111;border-bottom:1px solid #222;position:sticky;top:0;z-index:5}
.brand{font-weight:700;letter-spacing:.3px;font-size:1rem;opacity:.9}
.spacer{flex:1}
.btn{background:#1f1f1f;border:1px solid #333;color:#fff;padding:.45rem .8rem;border-radius:.75rem;cursor:pointer}
.btn.subtle{background:#0e0e0e}
.btn:active{transform:scale(.98)}

/* Enhancement #1: Navigation Controls (WORKING) */
.nav-controls{display:flex;justify-content:center;gap:.5rem;padding:.75rem;background:#0a0a0a;border-bottom:1px solid #222;}
.nav-btn{background:#1a1a1a;border:1px solid #333;color:#fff;padding:.6rem 1rem;border-radius:8px;cursor:pointer;font-size:.9rem;font-weight:500;transition:all .2s ease;}
.nav-btn:hover{background:#2a2a2a;border-color:#444;}
.nav-btn:active{transform:scale(.95);background:#333;}

#stage{position:relative;flex:1;overflow:hidden;display:flex;align-items:center;justify-content:center;padding:1rem}
#anchorWrap{position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.5rem}
#anchorImg{max-width:min(75vw,560px);max-height:min(65vh,560px);object-fit:contain;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.6);border:1px solid #222}
.name{font-size:1.1rem;opacity:.95;min-height:1.3em}
.details{font-size:0.9rem;opacity:.75;text-align:center;margin-top:.25rem}
.details .date{color:#7aa8ff}
.details .location{color:#90ee90}
.details .notes{font-style:italic;margin-top:.25rem;opacity:.6}
#gridOverlay{position:absolute;inset:0;background:#000;display:flex;flex-direction:column;z-index:4;align-items:center}
#gridOverlay.hidden{display:none}
.gridHeader{padding:.5rem 1rem;border-bottom:1px solid #222;width:100%;max-width:980px}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;padding:1rem;width:100%;max-width:980px;overflow-y:auto;-webkit-overflow-scrolling:touch;justify-content:center}
.grid.single{grid-template-columns:1fr;max-width:320px}
.grid.dual{grid-template-columns:repeat(2,1fr);max-width:660px}
.gridItem{position:relative;display:flex;flex-direction:column;align-items:center;gap:.4rem;cursor:pointer;padding:.5rem;border-radius:12px;background:#111;border:1px solid #222}
.gridItem:hover{background:#1a1a1a;border-color:#333}
.gridImg{width:120px;height:120px;object-fit:cover;border-radius:8px;border:1px solid #333}
.gridImg.missing{background:#222;display:flex;align-items:center;justify-content:center;color:#666;font-size:2rem}
.gridName{font-size:.9rem;text-align:center;min-height:1.1em}
.gridDetails{font-size:.75rem;opacity:.7;text-align:center}
#editOverlay{position:fixed;inset:0;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:10;padding:1rem}
#editOverlay.hidden{display:none}
.editForm{background:#111;border:1px solid #333;border-radius:16px;padding:1.5rem;width:100%;max-width:400px}
.editForm h3{margin:0 0 1rem 0;font-size:1.1rem}
.editForm label{display:block;margin:.5rem 0 .25rem;font-size:.9rem;opacity:.8}
.editForm input,.editForm textarea{width:100%;padding:.5rem;background:#222;border:1px solid #333;color:#fff;border-radius:6px;font-family:inherit}
.editForm textarea{resize:vertical;height:80px}
.editActions{display:flex;gap:.5rem;margin-top:1rem}
.editActions button{flex:1;padding:.6rem;border:none;border-radius:6px;cursor:pointer;font-weight:500}
.save{background:#0066cc;color:#fff}
.save:hover{background:#0052a3}
.cancel{background:#333;color:#fff}
.cancel:hover{background:#444}
.delete{background:#cc0000;color:#fff}
.delete:hover{background:#990000}
.statusMsg{position:fixed;top:1rem;right:1rem;padding:.5rem 1rem;border-radius:6px;z-index:20;font-size:.9rem}
.statusMsg.success{background:#0c5a0c;border:1px solid #0d7c0d;color:#90ee90}
.statusMsg.error{background:#5a0c0c;border:1px solid #7c0d0d;color:#ff9090}
.statusMsg.info{background:#0c3a5a;border:1px solid #0d5a7c;color:#7aa8ff}
#debugInfo{position:fixed;bottom:1rem;left:1rem;background:#222;border:1px solid #444;padding:.5rem;border-radius:6px;font-size:.75rem;font-family:monospace;max-width:300px;z-index:15}
#debugInfo.hidden{display:none}
</style>
</head>
<body>
<div id="app">
  <div class="topbar">
    <div class="brand">SwipeTree</div>
    <div class="spacer"></div>
    <button class="btn" id="editBtn">Edit</button>
  </div>
  
  <!-- Enhancement #1: Navigation Controls -->
  <div class="nav-controls">
    <button class="nav-btn" id="navParents">PARENTS</button>
    <button class="nav-btn" id="navPartner">PARTNER</button>
    <button class="nav-btn" id="navSiblings">SIBLINGS</button>
    <button class="nav-btn" id="navChildren">CHILDREN</button>
  </div>
  
  <div id="stage">
    <div id="anchorWrap">
      <img id="anchorImg" alt="Family member">
      <div class="name" id="anchorName"></div>
      <div class="details" id="anchorDetails"></div>
    </div>
  </div>
  
  <div id="gridOverlay" class="hidden">
    <div class="gridHeader">
      <h2 id="gridTitle"></h2>
      <button class="btn" id="closeGrid">← Back</button>
    </div>
    <div class="grid" id="grid"></div>
  </div>
  
  <div id="editOverlay" class="hidden">
    <div class="editForm">
      <h3>Edit Details</h3>
      <label>Name:</label>
      <input id="editName" type="text">
      <label>Birth Date:</label>
      <input id="editBirth" type="text" placeholder="e.g., March 15, 1985">
      <label>Location:</label>
      <input id="editLocation" type="text" placeholder="e.g., Austin, TX">
      <label>Notes:</label>
      <textarea id="editNotes" placeholder="Additional details..."></textarea>
      <div class="editActions">
        <button class="save" id="saveEdit">Save</button>
        <button class="cancel" id="cancelEdit">Cancel</button>
        <button class="delete" id="deleteEdit">Delete</button>
      </div>
    </div>
  </div>
</div>

<div id="debugInfo" class="hidden"></div>

<script>
class SwipeTreeApp {
  constructor() {
    this.currentId = '111100';
    this.labels = new Map();
    this.spouseMap = new Map();
    this.imageBaseUrl = 'https://raw.githubusercontent.com/allofusbhere/family-tree-images/main/';
    this.apiBaseUrl = 'https://api.github.com/repos/allofusbhere/swipe-tree-labels/contents/';
    
    this.touchStartX = null;
    this.touchStartY = null;
    this.touchEndX = null;
    this.touchEndY = null;
    
    this.init();
  }
  
  init() {
    this.setupEventListeners();
    this.loadData().then(() => {
      this.loadPerson(this.currentId);
    });
  }
  
  setupEventListeners() {
    // Touch events
    document.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: true });
    document.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: true });
    
    // Navigation buttons (Enhancement #1)
    document.getElementById('navParents').addEventListener('click', () => this.showParents());
    document.getElementById('navPartner').addEventListener('click', () => this.navigateToSpouse());
    document.getElementById('navSiblings').addEventListener('click', () => this.showSiblings());
    document.getElementById('navChildren').addEventListener('click', () => this.showChildren());
    
    // Other buttons
    document.getElementById('editBtn').addEventListener('click', () => this.showEditForm());
    document.getElementById('closeGrid').addEventListener('click', () => this.hideGrid());
    document.getElementById('saveEdit').addEventListener('click', () => this.saveEdit());
    document.getElementById('cancelEdit').addEventListener('click', () => this.hideEditForm());
    document.getElementById('deleteEdit').addEventListener('click', () => this.deleteLabel());
  }
  
  async loadData() {
    try {
      await Promise.all([
        this.loadFamilyLabels(),
        this.loadSpouseMap()
      ]);
    } catch (error) {
      console.error('Error loading data:', error);
      this.showMessage('Error loading data. Using offline mode.', 'error');
    }
  }
  
  async loadFamilyLabels() {
    try {
      const response = await fetch(`${this.apiBaseUrl}family_labels.json`);
      const data = await response.json();
      const content = JSON.parse(atob(data.content));
      
      content.forEach(entry => {
        this.labels.set(entry.id, entry);
      });
      
      this.showMessage(`Loaded family labels from GitHub: ${content.length} entries`, 'success');
    } catch (error) {
      console.log('GitHub labels not available, using localStorage fallback');
      const stored = localStorage.getItem('family_labels');
      if (stored) {
        const data = JSON.parse(stored);
        data.forEach(entry => {
          this.labels.set(entry.id, entry);
        });
      }
    }
  }
  
  async loadSpouseMap() {
    try {
      const response = await fetch(`${this.apiBaseUrl}spouse_link.json`);
      const data = await response.json();
      const content = JSON.parse(atob(data.content));
      
      Object.entries(content).forEach(([id, spouseId]) => {
        this.spouseMap.set(id, spouseId);
      });
      
      console.log('Loaded spouse map:', this.spouseMap);
    } catch (error) {
      console.log('Spouse map not available');
    }
  }
  
  handleTouchStart(e) {
    if (e.target.closest('#gridOverlay') || e.target.closest('#editOverlay')) return;
    
    this.touchStartX = e.changedTouches[0].screenX;
    this.touchStartY = e.changedTouches[0].screenY;
  }
  
  handleTouchEnd(e) {
    if (e.target.closest('#gridOverlay') || e.target.closest('#editOverlay')) return;
    if (!this.touchStartX || !this.touchStartY) return;
    
    this.touchEndX = e.changedTouches[0].screenX;
    this.touchEndY = e.changedTouches[0].screenY;
    
    this.handleSwipe();
  }
  
  handleSwipe() {
    const deltaX = this.touchEndX - this.touchStartX;
    const deltaY = this.touchEndY - this.touchStartY;
    const minSwipeDistance = 50;
    
    if (Math.abs(deltaX) < minSwipeDistance && Math.abs(deltaY) < minSwipeDistance) return;
    
    if (Math.abs(deltaX) > Math.abs(deltaY)) {
      // Horizontal swipe
      if (deltaX > 0) {
        this.navigateToSpouse(); // Right swipe
      } else {
        this.showSiblings(); // Left swipe
      }
    } else {
      // Vertical swipe
      if (deltaY > 0) {
        this.showChildren(); // Down swipe
      } else {
        this.showParents(); // Up swipe
      }
    }
  }
  
  loadPerson(id) {
    this.currentId = id;
    const img = document.getElementById('anchorImg');
    const name = document.getElementById('anchorName');
    const details = document.getElementById('anchorDetails');
    
    img.src = `${this.imageBaseUrl}${id}.jpg`;
    img.onerror = () => {
      img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400" viewBox="0 0 400 400"><rect width="400" height="400" fill="%23222"/><text x="200" y="200" text-anchor="middle" fill="%23666" font-size="24">No Image</text></svg>';
    };
    
    const label = this.labels.get(id);
    if (label) {
      name.textContent = label.name;
      let detailsHtml = '';
      if (label.birth) detailsHtml += `<span class="date">${label.birth}</span>`;
      if (label.location) detailsHtml += `${detailsHtml ? ' • ' : ''}<span class="location">${label.location}</span>`;
      if (label.notes) detailsHtml += `<div class="notes">${label.notes}</div>`;
      details.innerHTML = detailsHtml;
    } else {
      name.textContent = `Person ${id}`;
      details.innerHTML = '<em>No information available</em>';
    }
  }
  
  navigateToSpouse() {
    const spouseId = this.spouseMap.get(this.currentId);
    if (spouseId) {
      this.loadPerson(spouseId);
    } else {
      this.showMessage('No spouse found for this person', 'info');
    }
  }
  
  showParents() {
    const parents = this.getParents(this.currentId);
    if (parents.length === 0) {
      this.showMessage('No parents found', 'info');
      return;
    }
    
    this.showGrid('Parents', parents);
  }
  
  showSiblings() {
    const siblings = this.getSiblings(this.currentId);
    if (siblings.length === 0) {
      this.showMessage('No siblings found', 'info');
      return;
    }
    
    this.showGrid('Siblings', siblings);
  }
  
  showChildren() {
    const children = this.getChildren(this.currentId);
    if (children.length === 0) {
      this.showMessage('No children found', 'info');
      return;
    }
    
    this.showGrid('Children', children);
  }
  
  getParents(id) {
    if (id.length !== 6) return [];
    const baseId = id.substring(0, 4);
    return [`${baseId}00`, `${baseId}00`].filter(pid => pid !== id);
  }
  
  getSiblings(id) {
    if (id.length !== 6) return [];
    const baseId = id.substring(0, 4);
    const currentNumber = parseInt(id.substring(4), 10);
    
    const siblings = [];
    for (let i = 1; i <= 20; i++) {
      if (i !== currentNumber) {
        const siblingId = `${baseId}${i.toString().padStart(2, '0')}`;
        siblings.push(siblingId);
      }
    }
    
    return siblings;
  }
  
  getChildren(id) {
    const prefix = id;
    const children = [];
    
    for (let i = 1; i <= 20; i++) {
      children.push(`${prefix}${i.toString().padStart(2, '0')}`);
    }
    
    return children;
  }
  
  showGrid(title, ids) {
    const overlay = document.getElementById('gridOverlay');
    const titleEl = document.getElementById('gridTitle');
    const grid = document.getElementById('grid');
    
    titleEl.textContent = title;
    grid.innerHTML = '';
    
    // Adjust grid layout based on number of items
    if (ids.length === 1) {
      grid.className = 'grid single';
    } else if (ids.length === 2) {
      grid.className = 'grid dual';
    } else {
      grid.className = 'grid';
    }
    
    ids.forEach(id => {
      const item = this.createGridItem(id);
      grid.appendChild(item);
    });
    
    overlay.classList.remove('hidden');
  }
  
  createGridItem(id) {
    const item = document.createElement('div');
    item.className = 'gridItem';
    item.onclick = () => {
      this.loadPerson(id);
      this.hideGrid();
    };
    
    const img = document.createElement('img');
    img.className = 'gridImg';
    img.src = `${this.imageBaseUrl}${id}.jpg`;
    img.onerror = () => {
      img.className = 'gridImg missing';
      img.alt = '👤';
      img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120"><rect width="120" height="120" fill="%23222"/><text x="60" y="70" text-anchor="middle" fill="%23666" font-size="36">👤</text></svg>';
    };
    
    const name = document.createElement('div');
    name.className = 'gridName';
    
    const details = document.createElement('div');
    details.className = 'gridDetails';
    
    const label = this.labels.get(id);
    if (label) {
      name.textContent = label.name;
      if (label.birth || label.location) {
        details.textContent = [label.birth, label.location].filter(Boolean).join(' • ');
      }
    } else {
      name.textContent = `Person ${id}`;
    }
    
    item.appendChild(img);
    item.appendChild(name);
    item.appendChild(details);
    
    return item;
  }
  
  hideGrid() {
    document.getElementById('gridOverlay').classList.add('hidden');
  }
  
  showEditForm() {
    const label = this.labels.get(this.currentId) || {};
    
    document.getElementById('editName').value = label.name || '';
    document.getElementById('editBirth').value = label.birth || '';
    document.getElementById('editLocation').value = label.location || '';
    document.getElementById('editNotes').value = label.notes || '';
    
    document.getElementById('editOverlay').classList.remove('hidden');
  }
  
  hideEditForm() {
    document.getElementById('editOverlay').classList.add('hidden');
  }
  
  async saveEdit() {
    const name = document.getElementById('editName').value.trim();
    const birth = document.getElementById('editBirth').value.trim();
    const location = document.getElementById('editLocation').value.trim();
    const notes = document.getElementById('editNotes').value.trim();
    
    if (!name) {
      this.showMessage('Name is required', 'error');
      return;
    }
    
    const newLabel = {
      id: this.currentId,
      name,
      birth,
      location,
      notes
    };
    
    this.labels.set(this.currentId, newLabel);
    this.loadPerson(this.currentId);
    this.hideEditForm();
    
    // Save to localStorage as backup
    const labelsArray = Array.from(this.labels.values());
    localStorage.setItem('family_labels', JSON.stringify(labelsArray));
    
    this.showMessage('Label saved successfully', 'success');
  }
  
  deleteLabel() {
    if (confirm('Are you sure you want to delete this label?')) {
      this.labels.delete(this.currentId);
      this.loadPerson(this.currentId);
      this.hideEditForm();
      
      // Update localStorage
      const labelsArray = Array.from(this.labels.values());
      localStorage.setItem('family_labels', JSON.stringify(labelsArray));
      
      this.showMessage('Label deleted', 'info');
    }
  }
  
  showMessage(text, type = 'info') {
    const existingMsg = document.querySelector('.statusMsg');
    if (existingMsg) existingMsg.remove();
    
    const msg = document.createElement('div');
    msg.className = `statusMsg ${type}`;
    msg.textContent = text;
    document.body.appendChild(msg);
    
    setTimeout(() => msg.remove(), 3000);
  }
}

// Initialize the app
new SwipeTreeApp();
</script>
</body>
</html>
